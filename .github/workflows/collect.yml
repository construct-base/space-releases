name: Collect Space Release

on:
  repository_dispatch:
    types: [space-release]

# Only one collect at a time to avoid conflicts
concurrency:
  group: collect-release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Parse dispatch payload
        id: meta
        run: |
          echo "space=${{ github.event.client_payload.space }}" >> "$GITHUB_OUTPUT"
          echo "version=${{ github.event.client_payload.version }}" >> "$GITHUB_OUTPUT"
          echo "repo=${{ github.event.client_payload.repo }}" >> "$GITHUB_OUTPUT"
          echo "name=${{ github.event.client_payload.display_name }}" >> "$GITHUB_OUTPUT"
          echo "description=${{ github.event.client_payload.description }}" >> "$GITHUB_OUTPUT"
          echo "icon=${{ github.event.client_payload.icon }}" >> "$GITHUB_OUTPUT"
          echo "scope=${{ github.event.client_payload.scope }}" >> "$GITHUB_OUTPUT"

      - name: Download tarball from source release
        env:
          GH_TOKEN: ${{ secrets.SPACE_RELEASES_TOKEN }}
        run: |
          SPACE="${{ steps.meta.outputs.space }}"
          VERSION="${{ steps.meta.outputs.version }}"
          REPO="${{ steps.meta.outputs.repo }}"

          mkdir -p "spaces/${SPACE}"

          # Download the tarball from the space repo's GitHub Release
          gh release download "v${VERSION}" \
            --repo "${REPO}" \
            --pattern "space-${SPACE}-v${VERSION}.tar.gz" \
            --dir "spaces/${SPACE}/" \
            || {
              echo "::warning::Could not download tarball, trying source archive"
              gh release download "v${VERSION}" \
                --repo "${REPO}" \
                --archive tar.gz \
                --dir "spaces/${SPACE}/"
              # Rename to standard format
              mv "spaces/${SPACE}"/*.tar.gz "spaces/${SPACE}/space-${SPACE}-v${VERSION}.tar.gz" 2>/dev/null || true
            }

          ls -la "spaces/${SPACE}/"

      - name: Save space metadata
        run: |
          SPACE="${{ steps.meta.outputs.space }}"
          VERSION="${{ steps.meta.outputs.version }}"
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Write per-space metadata file (conflict-free â€” each space writes its own file)
          node -e "
            const fs = require('fs');
            const meta = {
              id: '${SPACE}',
              name: '${{ steps.meta.outputs.name }}',
              version: '${VERSION}',
              description: '${{ steps.meta.outputs.description }}',
              icon: '${{ steps.meta.outputs.icon }}',
              scope: '${{ steps.meta.outputs.scope }}',
              repo: '${{ steps.meta.outputs.repo }}',
              tarball: 'spaces/${SPACE}/space-${SPACE}-v${VERSION}.tar.gz',
              released_at: '${NOW}'
            };
            fs.writeFileSync('spaces/${SPACE}/metadata.json', JSON.stringify(meta, null, 2) + '\n');
          "

      - name: Commit and push with index rebuild
        run: |
          SPACE="${{ steps.meta.outputs.space }}"
          VERSION="${{ steps.meta.outputs.version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          for i in 1 2 3 4 5; do
            # Pull latest to get any changes from other collect runs
            git pull --rebase=false 2>/dev/null || true

            # Stage the new tarball and metadata (these are unique per space, no conflict)
            git add "spaces/${SPACE}/"

            # Rebuild index.json from ALL metadata files (always conflict-free)
            node -e "
              const fs = require('fs');
              const path = require('path');
              const spacesDir = 'spaces';
              const spaces = [];

              for (const name of fs.readdirSync(spacesDir).sort()) {
                const metaFile = path.join(spacesDir, name, 'metadata.json');
                if (fs.existsSync(metaFile)) {
                  spaces.push(JSON.parse(fs.readFileSync(metaFile, 'utf8')));
                }
              }

              const idx = {
                version: 1,
                updated_at: new Date().toISOString().replace(/\.\d+Z/, 'Z'),
                spaces
              };

              fs.writeFileSync('index.json', JSON.stringify(idx, null, 2) + '\n');
              console.log('Index rebuilt with ' + spaces.length + ' spaces');
            "

            git add index.json
            git diff --cached --quiet && { echo "No changes to commit"; break; }
            git commit -m "release: ${SPACE} v${VERSION}"

            if git push; then
              echo "Push succeeded"
              break
            fi

            echo "Push failed ($i/5), resetting and retrying..."
            git reset --soft HEAD~1
            sleep 2
          done

          cat index.json
